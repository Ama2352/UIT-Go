# =============================================================================
# CD Workflow - Deploy to Azure VM
# =============================================================================
# Runs: After CI workflow completes successfully on main branch
# What it does:
#   1. SSH into Azure VM
#   2. Pull latest code and Docker images
#   3. Restart services with docker compose
#   4. Run health checks
# =============================================================================

name: CD - Deploy to Azure

on:
  # Automatically run after CI completes
  workflow_run:
    workflows: ["CI - Build and Test"]
    types:
      - completed
    branches: 
      - main
      - feature/terraform-azure-cicd
  
  # Also allow manual trigger
  workflow_dispatch:

jobs:
  deploy:
    name: üöÄ Deploy to Azure VM
    runs-on: ubuntu-latest
    
    # Only run if CI was successful (or manual trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üîê Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          script: |
            echo "=========================================="
            echo "üöÄ Starting deployment..."
            echo "=========================================="
            
            # Navigate to app directory
            cd /opt/uit-go
            
            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin main
            
            # Login to GitHub Container Registry
            echo "üîë Logging into container registry..."
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # Pull latest images
            echo "üê≥ Pulling latest Docker images..."
            docker compose pull
            
            # Restart services with new images
            echo "‚ôªÔ∏è Restarting services..."
            docker compose up -d --remove-orphans
            
            # Clean up old images to save disk space
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # Show current status
            echo "=========================================="
            echo "üìä Current service status:"
            echo "=========================================="
            docker compose ps
            
            echo ""
            echo "‚úÖ Deployment complete!"
      
      - name: ‚è≥ Wait for services to start
        run: sleep 30
      
      - name: üè• Health Check
        run: |
          echo "Running health check..."
          
          # Check Kong Gateway
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.AZURE_VM_HOST }}:8000/ || echo "000")
          
          if [ "$HTTP_STATUS" = "000" ]; then
            echo "‚ö†Ô∏è Warning: Could not connect to Kong Gateway"
            echo "This might be normal if Kong is still starting up"
          else
            echo "‚úÖ Kong Gateway responded with status: $HTTP_STATUS"
          fi
          
          echo ""
          echo "üéâ Deployment finished!"
          echo "üåê API available at: http://${{ secrets.AZURE_VM_HOST }}:8000"
